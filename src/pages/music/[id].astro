---
// src/pages/music/[id].astro
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import SongViewer from "../../components/SongViewer.jsx";
import supabase from "../../lib/supabase";
import FancyText from "../../components/FancyText.jsx";

const { id } = Astro.params;

// Fetch con manejo de errores para modo offline
let song = null;
let isOffline = false;

try {
  const { data, error } = await supabase
    .from("cantos")
    .select(
      "id, titulo, tono, autor, version, cuerpo, historia, pdf, fundamento_biblico, youtube_url, mp3_urls",
    )
    .eq("id", id)
    .single();

  if (error) throw error;
  song = data;
} catch (e) {
  console.error("Failed to fetch song:", e);
  isOffline = true;
  // Pasamos null - SongViewer buscará en cache
}
---

<Layout title={song?.titulo || "Cargando..."}>
  {
    isOffline && (
      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mx-4 mt-4 text-center">
        <p class="text-amber-800 font-medium">⚠️ Modo Offline</p>
        <p class="text-amber-700 text-sm">
          Buscando canción en datos locales...
        </p>
      </div>
    )
  }

  <h2 class="text-center my-8">
    <FancyText
      text={song?.titulo || "Cargando..."}
      colors={["#40ffaa", "#4079ff", "#ff40c6"]}
      animationSpeed={4}
      showBorder
      className="text-4xl font-extrabold"
      client:only="react"
    />
  </h2>
  <br />
  <!-- SongViewer buscará en cache si song es null -->
  <SongViewer song={song || { id: id }} client:only="react" />
</Layout>
